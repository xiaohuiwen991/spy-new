<div id="add-table-connection-block">
<div class="query-condition mt10 tac">
    <form id="connection-form">
        <div class="query-condition-p">
            <input id="tableName" name="tableName"  class="hide"/>
            <span class="common-field w65">表名：</span>
            <input name="tableName1"  class="common-input mr15"/>
            <span class="common-field w65">字段名：</span>
            <input name="column1" class="common-input mr15"/>
            <p class="query-reset">
                <b class="cm-query-btn mr15" id="query-btn-connect"></b>
                <b class="cm-reset-btn" id="reset-btn-connect"></b>
            </p>
        </div>
    </form>
</div>
<div id="query-result-connect">
    <div class="new-color-bar">
        <span class="title">表连接信息（共找到<span class="total-count"></span>条数据）</span>
        <div class="bar-btn-div">
            <b class="table-ok cm-ok-btn open-no-fix-btn"></b>
            <b class="cm-add-btn-connect cm-add-btn"></b>
        </div>
    </div>
    <table id="connection-connection-table" class="typical-tb">
        <thead>
            <th class="text-center"><input type="checkbox" id="tableCheckAll"/></th>
            <th class="text-center">序号</th>
            <th class="text-center">表名1</th>
            <th class="text-center">字段名1</th>
            <th class="text-center">表名2</th>
            <th class="text-center">字段名2</th>
            <th class="text-center">连接类型</th>
            <th class="text-center">操作</th>
        </thead>
        <tbody tpsource="#connection-connection-list"></tbody>
    </table>
    <div class="paging"></div>
</div>
<!--新增弹窗-->
<div id="add-connection-block" class="hide">
    <form id="add-form-connection">
        <p class="mt30">
            <span class="common-field w65"><span class="orangered">★ </span>表名1：</span>
            <dict dict-type="select" id="tableName1-select-add" dict-id="tableName1-select-add-dict" dict-name="tableName1" class="tableName1" empty="false"></dict>
            <span class="common-field w65"><span class="orangered">★ </span>字段名1：</span>
            <dict dict-type="select" id="column1-select-add" dict-name="column1"  class="dict" empty="false"></dict>
        </p>
        <p class="mt30">
            <span class="common-field w65"><span class="orangered">★ </span>表名2：</span>
            <dict dict-type="select" id="tableName2-select-add" dict-name="tableName2" dict-id="tableName2-select-add-dict" class="tableName2" empty="false"></dict>
            <span class="common-field w65"><span class="orangered">★ </span>字段名2：</span>
            <dict dict-type="select" id="column2-select-add" dict-name="column2"  class="dict" empty="false"></dict>
        </p>
        <p class="mt30">
            <span class="common-field w65"><span class="orangered">★ </span>连接类型：</span>
            <dict id="connectionType-dict-add" dict-name="connectionType" dict-type="select" dict-root="LJLBDM"  empty="false"></dict>
        </p>
        <p class="mt20 tcenter mb10">
            <b id="add-save-btn-connect" class="cm-save-btn mr15"></b>
            <b id="add-close-btn-connect" class="cm-cancel-btn"></b>
        </p>
    </form>
</div>
<!--修改弹窗-->
<div id="edit-connection-block" class="hide">
    <form id="edit-form-connection">
        <input id="edit-id" name="mainId" type="hidden"/>
        <div id="edit-connection">
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>表名1：</span>
                <dict dict-type="select" id="tableName1-select-edit" dict-id="tableName1-select-edit-dict" dict-name="tableName1" class="tableName1" empty="false"></dict>
                <span class="common-field w65"><span class="orangered">★ </span>字段名1：</span>
                <dict dict-type="select" id="column1-select-edit" dict-name="column1"  class="dict" empty="false"></dict>
            </p>
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>表名2：</span>
                <dict dict-type="select" id="tableName2-select-edit" dict-name="tableName2" dict-id="tableName2-select-edit-dict" class="tableName2" empty="false"></dict>
                <span class="common-field w65"><span class="orangered">★ </span>字段名2：</span>
                <dict dict-type="select" id="column2-select-edit" dict-name="column2"  class="dict" empty="false"></dict>
            </p>
            <p class="mt30">
                <span class="common-field w65"><span class="orangered">★ </span>连接类型：</span>
                <dict id="connectionType-dict-edit" dict-name="connectionType" dict-type="select" dict-root="LJLBDM" empty="false"></dict>
            </p>
        </div>
        <p class="mt20 tcenter mb10">
            <b id="edit-save-btn-connect" class="cm-save-btn mr15"></b>
            <b id="edit-close-btn-connect" class="cm-cancel-btn"></b>
        </p>
    </form>
</div>
<!--查看弹窗-->
<div id="check-connection-block" class="hide">
    <div id="check-connection">
        <p class="mt30">
            <span class="common-field w65">表名1：</span>
            <input name="name"  class="common-input mr15" value = '{tableName1Str}' readonly></select>
            <span class="common-field w65">字段名1：</span>
            <input name="url" class="common-input validate mr15" value = '{column1}' readonly></select>
        </p>
        <p class="mt30">
            <span class="common-field w65">表名2：</span>
            <input name="username"  class="common-input validate mr15" value = '{tableName2Str}' readonly></select>
            <span class="common-field w65">字段名2：</span>
            <input name="password"  class="common-input validate mr15" value = '{column2}' readonly></select>
        </p>
        <p class="mt30">
            <span class="common-field w65">连接类型：</span>
            <input name="username"  class="common-input validate mr15" value = '{connectionTypeZw}' readonly></select>
        </p>
    </div>
    <p class="mt20 tcenter mb10">
        <b id="check-close-btn-connect" class="cm-cancel-btn"></b>
    </p>
</div>
</div>
<script type="text/template" id="connection-connection-list">
    <tr class="{$nth2}">
        <td><input type="checkbox" {_checked} class="tableCheckBox"  rownum="{rownum}"/></td>
        <td>{rownum}</td>
        <td>{tableName1Str}</td>
        <td>{column1}</td>
        <td>{tableName2Str}</td>
        <td>{column2}</td>
        <td>{connectionTypeZw}</td>
        <td>
            <i class="icon-show-btn-connect icon-show-btn" title="查看" param="{id}"></i>
            <i class="icon-edit-btn-connect icon-edit-btn" title="修改" param="{id}" ></i>
            <i class="icon-remove-btn-connect icon-remove-btn" title="删除" param="{id}"></i>
        </td>
    </tr>
</script>
<script src="../../dist/js/base.js"></script>
<script>
    function intoTableConnectSelectMult(selectWin,pageNO) {
        top.registry.database.selectTableConnectWin = selectWin;
        top.registry.database.selectTableConnectPageNO = pageNO;
    }

    // 在doc准备好后,写js逻辑
    importing('dict',function () {
        var   connectionListAction = top.path+'/api/0/database/table_connection/list',
                saveAddAction = top.path+'/api/0/database/table_connection/add',
                saveEditAction = top.path+'/api/0/database/table_connection/edit',
                deleteAction = top.path+'/api/0/database/table_connection/delete',
                infoAction = top.path+'/api/0/database/table_connection/info',
                columnAction = top.path+'/api/0/database/column/column_list',
                pageData = [];

        $('.dict').dict();

        /**
         * 最后一页删除操作后刷新页面
         * @param pageNum 当前列表数量
         * @param delNum 要删除的数量
         * @returns {*}
         */
        function getCurrentPage2LastPageDel(pageNum, delNum){
            var $paging = $('.paging');
            var cpage = $paging.data('currentPage');
            if($paging.find('span.current.next').length > 0){ //在最后一页进行删除操作时
                if(pageNum ==  delNum){
                    cpage = cpage - 1;
                }
            }
            return cpage;
        }

        var closeWin = function(winId,resetForm) {
            if(winId){
                $(winId).$close();
            }
            if(resetForm) {
                $(resetForm)[0].reset();
            }
            $('.validate').removeClass('validatebox-invalid');
        }

        function loadConnectionList(currentPage) {
            top.registry.database.checkTableConnects = [];
            var tableName = [];
            for(var o in top.registry.database.tableDict) {
                var obj = top.registry.database.tableDict[o];
                tableName[o] = obj.key;
            }
            $('#tableName').val(tableName);
            $('#query-result-connect').pagingList({
                action:connectionListAction,
                currentPage:currentPage,
                jsonObj:$('#connection-form').serializeObject(),
                callback:pageBack
            });
        }

        //判断该页面是否进行全选
        function judgeCheckAll(){
            var checkAll = true;
            var arryCheck = $(".tableCheckBox");
            if(arryCheck.length == 0) {
                checkAll = false;
            }else {
                $(arryCheck).each(function () {
                    if (!this.checked) {
                        checkAll = false;
                    }
                });
            }
            $('#tableCheckAll').prop('checked',checkAll);
        }

        function pageBack(data) {
            pageData = data;
            $('#connection-connection-table').find('tbody').template(data, function(item, i){
                for(var o in top.registry.database.tableDict) {
                    var obj = top.registry.database.tableDict[o];
                    if(item.tableName1 == obj.key) {
                        item.tableName1Str = obj.value;
                    }
                    if(item.tableName2 == obj.key) {
                        item.tableName2Str = obj.value;
                    }
                }
                
                var checkedTablesLen,
                        j,
                        checkedJ;
                item._checked = null;
                for(j=0,checkedTablesLen = top.registry.database.checkTableConnects.length;j<checkedTablesLen;j++){
                    checkedJ = top.registry.database.checkTableConnects[j];
                    if(checkedJ.rownum == item.rownum) {
                        item._checked = 'checked';
                        return false;
                    }
                }
            });
            judgeCheckAll();
            $('.tableCheckBox').off('click').on('click',function(){
                var i = $(this).index('.tableCheckBox');
                var rownum=+(this.getAttribute('rownum'));
                if(this.checked){
                    top.registry.database.checkTableConnects.push({rownum:rownum,data:data[i]});
                }else{
                    if(top.registry.database.checkTableConnects && top.registry.database.checkTableConnects.length > 0){
                        if(top.registry.database.checkTableConnects.where('o=>o.rownum == "1"')){
                            var t_index = $.inArray(top.registry.database.checkTableConnects.where('o=>o.rownum == "'+rownum+'"')[0], top.registry.database.checkTableConnects);
                            top.registry.database.checkTableConnects.splice(t_index, 1);
                        }
                    }
                }
                judgeCheckAll();
            });
            //全选操作
            $('#tableCheckAll').off('click').on('click',function(){
                $(".tableCheckBox").prop('checked',$(this).prop('checked'));
                var arryCheck = $(".tableCheckBox");
                var t_rownum = '';
                $(arryCheck).each(function(i){
                    t_rownum = this.getAttribute('rownum');
                    if(this.checked) {
                        top.registry.database.checkTableConnects.push({rownum: t_rownum, data: data[i]});
                    }else{
                        var t_index = $.inArray(top.registry.database.checkTableConnects.where('o=>o.rownum == "'+t_rownum+'"')[0], top.registry.database.checkTableConnects);
                        if(t_index > -1){
                            top.registry.database.checkTableConnects.splice(t_index, 1);
                        }
                    }
                });
            });
            
            
            //修改
            $('.icon-edit-btn-connect').on('click',function () {
                $open('#edit-connection-block',{title:'表连接修改',width:820,onClose:function () {
                    closeWin('','#edit-form-connection');
                }});
                //初始化修改弹窗数据
                initWinDataConnect.call(this, 'edit');
            });
            //查看
            $('.icon-show-btn-connect').on('click',function () {
                $open('#check-connection-block',{title:'表连接查看',width:820});
                //显示查看弹窗数据
                initWinDataConnect.call(this, 'check');
            });
            //删除
            $('.icon-remove-btn-connect').on('click',function () {
                var id = $(this).attr('param');
                $confirm('确认要删除这条表连接吗？',function (del) {
                    if(del){
                        $post(deleteAction,{id:id}, function (res) {
                            var msg = res.msg?res.msg:'删除成功！';
                            toast(msg,600).ok();
                            //加载表连接列表数据
                            loadConnectionList(getCurrentPage2LastPageDel($('#connection-connection-table tbody tr').length, 1));
                        });
                    }
                });

            });

        }
        function init() {
            //加载表连接列表数据
            loadConnectionList();
        }

        function saveConnection(action,params,winId,formId) {
            //验证
            $(winId+' .validate').validatebox();
            if($('.validatebox-invalid').length>0){
                return false;
            }
            //保存
            $post(action,params,function (res) {
                var msg = res.msg?res.msg:'保存成功！';
                closeWin(winId,formId);
                toast(msg,600).ok();
                //加载表连接列表数据
                loadConnectionList($('.paging').data('currentPage'));
            },true);

        }
        function initWinDataConnect(type) {
            var that = $(this);
            var id = that.attr('param');
            $post(infoAction,{id:id},function(res) {
                var data = res.data;
                if(type == 'edit') {
                    initWinDict('edit', data);
                    $('#edit-id').val(data.id);
                } else {
                    $template('#check-connection', res.data, function(item,i){
                        for(var o in top.registry.database.tableDict) {
                            var obj = top.registry.database.tableDict[o];
                            if(item.tableName1 == obj.key) {
                                item.tableName1Str = obj.value;
                            }
                            if(item.tableName2 == obj.key) {
                                item.tableName2Str = obj.value;
                            }
                        }

                    });
                }
            });
        }

        function initWinDict(type, data) {
            if(data) {} else {data = {}}
            var connect = $('#connectionType-dict-'+type).dict();
            if(data.connectionType) {
                connect.dictSelect(data.connectionType);
            }
            var table1 = $('#tableName1-select-'+type).dict(top.registry.database.tableDict, function(){
                initColumnDict($('#tableName1-select-'+type+'-dict').val(), 'column1-select-'+type, data.column1);
            });
            if(data.tableName1) {
                table1.dictSelect(data.tableName1);
            }
            var table2 = $('#tableName2-select-'+type).dict(top.registry.database.tableDict, function() {
                initColumnDict($('#tableName2-select-'+type+'-dict').val(), 'column2-select-'+type, data.column2);
            });
            if(data.tableName2) {
                table2.dictSelect(data.tableName2);
            }
            $('#'+type+'-connection-block').on('change', '.tableName1', function() {
                initColumnDict($('#tableName1-select-'+type+'-dict').val(), 'column1-select-'+type);
            }).on('change', '.tableName2', function() {
                initColumnDict($('#tableName2-select-'+type+'-dict').val(), 'column2-select-'+type);
            });
        }

        function initColumnDict(tableName, divId, value) {
            $post(columnAction,{tableName:tableName},function(res) {
                var dict = $('#'+divId).dict(res.data);
                if(value) {
                    dict.dictSelect(value);
                }
            });

        }

        init();

        //查询
        $('#query-btn-connect').on('click',function () {
            loadConnectionList();
        });
        //重置
        $('#reset-btn-connect').on('click',function () {
            $('#connection-form')[0].reset();
            $('#match-page').html('');
        });
        //新增
        $('.cm-add-btn-connect').on('click',function () {
            $open('#add-connection-block',{title:'表连接新增',width:820,onClose:function () {
                closeWin('','#add-form-connection');
            }});
            initWinDict('add');
        });
        //关闭新增弹窗
        $('#add-close-btn-connect').on('click',function () {
            closeWin('#add-connection-block','#add-form-connection');
        });
        //保存新增内容
        $('#add-save-btn-connect').on('click',function () {
            if($('#tableName1-select-add-dict').val() == $('#tableName2-select-add-dict').val()) {
                alert("不能连接同一张表!");
                return false;
            }
            saveConnection(saveAddAction,$('#add-form-connection').serializeObject(),'#add-connection-block','#add-form-connection');
        });

        //关闭修改弹窗
        $('#edit-close-btn-connect').on('click',function () {
            closeWin('#edit-connection-block','#edit-form-connection');
        });
        //保存修改内容
        $('#edit-save-btn-connect').on('click',function () {
            if($('#tableName1-select-edit-dict').val() == $('#tableName2-select-edit-dict').val()) {
                alert("不能连接同一张表!");
                return false;
            }
            saveConnection(saveEditAction,$('#edit-form-connection').serializeObject(),'#edit-connection-block','#edit-form-connection');
        });
        //关闭查看弹窗
        $('#check-close-btn-connect').on('click',function () {
            $('#check-connection-block').$close();
        });
    });

</script>
</html>
